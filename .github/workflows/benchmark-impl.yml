name: ⚙️ Benchmark

on:
  workflow_call: # This is a component workflow
    inputs:
      python:
        required: true
        type: string
        description: >
          Which Pythons to use, as a string or JSON array of strings (the version IDs).
      num_elements:
        required: true
        type: string
        description: >
          How many elements to make in the workflow, as a number or JSON array of numbers.
      platform:
        required: true
        type: string
        description: >
          Which OS to use, as a string or JSON array of strings (the runner IDs).
      executable_name:
        required: true
        type: string
        description: >
          Template parameter.
          Root name of executable.
      benchmark_make_workflow:
        required: true
        type: string
        description: >
          Template parameter.
          Path to application workflow used for benchmarking purposes.
      ref:
        required: true
        type: string
        description: The `github.ref` to benchmark.
      poetry-version:
        required: false
        type: string
        default: "1.4"
        description: >
          The version of Poetry to use.
    outputs:
      url:
        description: >
          Where you may download the benchmark data from.
          This is a temporary URL with access controls applied.
        value: ${{ jobs.upload.outputs.url }}

jobs:
  make:
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJSON(inputs.python)}}
        os: ${{ fromJSON(inputs.platform)}}
        num_elements: ${{ fromJSON(inputs.num_elements)}}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - uses: hpcflow/github-support/setup-poetry@0.2
        with:
          version: ${{ inputs.poetry-version }}
      - uses: hpcflow/github-support/init-cache@0.2
        with:
          name: benchmark
          version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          poetry install --without dev,pyinstaller

      - name: Set up variables
        id: vars
        run: |
          echo "timeit=benchmark_make_workflow_${{ matrix.num_elements }}_elements-${{ runner.os }}-py-${{ matrix.python-version }}.txt" >> $GITHUB_OUTPUT
        shell: bash

      - name: Run app make workflow command
        run: |
          poetry run $EXECUTABLE --timeit-file $TIMEIT_FILE make $BENCHMARK --var N $N_ELEMS
        env:
          EXECUTABLE: ${{ inputs.executable_name }}
          BENCHMARK: ${{ inputs.benchmark_make_workflow }}
          TIMEIT_FILE: ${{ steps.vars.outputs.timeit }}
          N_ELEMS: ${{ matrix.num_elements }}
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.vars.outputs.timeit }}
          path: ${{ steps.vars.outputs.timeit }}

  upload:
    needs: make
    outputs:
      url: ${{ steps.upload.outputs.artifact-url }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          mkdir benchmarks
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: benchmarks
      - uses: actions/upload-artifact@v4
        id: upload
        with:
          name: benchmarks
          path: benchmarks
